<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°°ë‹¹í”½(Dividend Pick) | ì‹¤ì‹œê°„ íˆ¬ì ë°ì´í„°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #121418; color: #e1e1e1; }
        .accent-green { color: #2ecc71; }
        .bg-card { background-color: #1c1f26; border: 1px solid #2d333e; }
        .btn-green { background-color: #2ecc71; color: #121418; font-weight: bold; }
        .ipo-tag { background-color: #2ecc71; color: #121418; font-size: 9px; font-weight: bold; border-radius: 4px; padding: 1px 3px; display: block; margin-top: 2px; }
    </style>
</head>
<body class="p-4 md:p-6">

    <header class="max-w-7xl mx-auto flex justify-between items-center py-4 mb-6 border-b border-gray-800">
        <div class="flex items-center gap-2">
            <div class="bg-[#2ecc71] p-2 rounded-lg"><i class="fa-solid fa-bolt text-black text-xl"></i></div>
            <h1 class="text-2xl font-black italic uppercase">Dividend <span class="accent-green">Pick</span></h1>
        </div>
        <div id="authArea" class="flex items-center gap-4 text-sm">
            <button id="loginBtn" onclick="window.login()" class="bg-white text-black px-4 py-2 rounded-full font-bold">êµ¬ê¸€ ë¡œê·¸ì¸</button>
            <div id="userInfo" class="hidden font-bold"><span id="userNick" class="accent-green"></span>ë‹˜ <button onclick="window.logout()" class="text-xs underline ml-2 opacity-50">ë¡œê·¸ì•„ì›ƒ</button></div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto grid grid-cols-1 xl:grid-cols-4 gap-6">
        <div class="xl:col-span-1">
            <section class="bg-card p-6 rounded-xl min-h-[500px]">
                <h2 class="text-lg font-bold mb-4 italic uppercase text-green-400 border-b border-gray-800 pb-2">Top IPO Ranking</h2>
                <div id="rankingList" class="space-y-4">
                    <p class="text-gray-500 text-center py-10">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
                </div>
            </section>
        </div>

        <div class="xl:col-span-2">
            <section class="bg-card p-6 rounded-xl">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-xl font-bold italic uppercase"><i class="fa-solid fa-calendar-days mr-2 accent-green"></i>IPO Calendar</h2>
                    <div class="flex items-center gap-3 bg-black p-2 rounded-lg">
                        <button onclick="window.changeMonth(-1)" class="hover:text-green-500"><i class="fa-solid fa-chevron-left"></i></button>
                        <span id="currentDateLabel" class="font-bold text-green-400 min-w-[100px] text-center"></span>
                        <button onclick="window.changeMonth(1)" class="hover:text-green-500"><i class="fa-solid fa-chevron-right"></i></button>
                    </div>
                </div>
                <div id="calendarGrid" class="grid grid-cols-7 gap-px bg-gray-700 border border-gray-700 rounded-lg overflow-hidden text-[10px]">
                    <div class="bg-gray-800 p-2 text-center text-red-400">ì¼</div>
                    <div class="bg-gray-800 p-2 text-center">ì›”</div><div class="bg-gray-800 p-2 text-center">í™”</div>
                    <div class="bg-gray-800 p-2 text-center">ìˆ˜</div><div class="bg-gray-800 p-2 text-center">ëª©</div>
                    <div class="bg-gray-800 p-2 text-center">ê¸ˆ</div><div class="bg-gray-800 p-2 text-center text-blue-400">í† </div>
                </div>
            </section>
        </div>

        <div class="xl:col-span-1">
            <section class="bg-card p-5 rounded-xl h-[550px] flex flex-col relative">
                <h2 class="font-bold mb-4 accent-green italic uppercase">Live Talk</h2>
                <div id="msgBox" class="flex-1 overflow-y-auto space-y-3 mb-4 text-xs"></div>
                <div id="chatInputArea" class="flex gap-2">
                    <input type="text" id="msg" placeholder="ì±„íŒ… ì…ë ¥..." class="flex-1 bg-black border border-gray-700 p-2 rounded text-sm outline-none">
                    <button onclick="window.sendMsg()" class="btn-green px-4 py-2 rounded">ì „ì†¡</button>
                </div>
            </section>
        </div>
    </main>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, serverTimestamp, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDaNmDpDXgiuELEO65Wk0PazVT2yeQeags",
        authDomain: "dividend-b090d.firebaseapp.com",
        projectId: "dividend-b090d",
        storageBucket: "dividend-b090d.firebasestorage.app",
        messagingSenderId: "543720180150",
        appId: "1:543720180150:web:15073a1e9706bb1f949917"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    let viewDate = new Date();
    let apiData = [];

    window.login = () => signInWithPopup(auth, provider);
    window.logout = () => signOut(auth);
    window.changeMonth = (v) => { viewDate.setMonth(viewDate.getMonth() + v); renderAll(); };

    async function fetchPublicData() {
        // ì¸ì¦í‚¤ë¥¼ ëª…ì‹œì ìœ¼ë¡œ ì„ ì–¸ (ì´ë¯¸ì§€ ë‚´ Encoding í‚¤)
        const sKey = "uDGP%2FFa5Y1fGcPUKw0BZ1Xsk2GDQnvbkgBhc9X4UjhWn7dr51gy94ulb7ZwLJDzp6sAJ7k5JR00SSAtC3sagrw%3D%3D";
        const url = `https://apis.data.go.kr/1160100/service/GetStocIssuInfoService_V2/getIpoTabInfo?serviceKey=${sKey}&resultType=json&numOfRows=50`;
        
        try {
            // AllOrigins í”„ë¡ì‹œë¥¼ í†µí•´ CORS ë° 404 ì—ëŸ¬ ë°©ì§€
            const res = await fetch(`https://api.allorigins.win/get?url=${encodeURIComponent(url)}`);
            const json = await res.json();
            const parsed = JSON.parse(json.contents);
            apiData = parsed.response.body.items.item || [];
            renderAll();
        } catch (e) {
            document.getElementById('rankingList').innerHTML = "<p class='text-red-500'>API ì—°ê²° ì‹¤íŒ¨</p>";
        }
    }

    function renderAll() {
        renderRanking();
        renderCalendar();
    }

    function renderRanking() {
        const list = document.getElementById('rankingList');
        // ê³µëª¨ê°€ ê¸°ì¤€ ìƒìœ„ 10ê°œ í‘œì‹œ
        const top10 = [...apiData].sort((a,b) => b.ipoPrcLow - a.ipoPrcLow).slice(0, 10);
        list.innerHTML = top10.map((item, i) => `
            <div class="flex justify-between items-center p-3 bg-black/40 rounded border border-gray-800">
                <span class="text-green-500 font-bold">0${i+1}</span>
                <span class="flex-1 ml-3 font-bold text-sm">${item.corpNm}</span>
                <span class="text-xs text-gray-400">${parseInt(item.ipoPrcLow).toLocaleString()}ì›</span>
            </div>
        `).join('');
    }

    function renderCalendar() {
        const grid = document.getElementById('calendarGrid');
        const label = document.getElementById('currentDateLabel');
        const y = viewDate.getFullYear();
        const m = viewDate.getMonth();
        label.innerText = `${y}.${String(m+1).padStart(2,'0')}`;

        while(grid.children.length > 7) grid.removeChild(grid.lastChild);
        const first = new Date(y, m, 1).getDay();
        const last = new Date(y, m+1, 0).getDate();

        for(let i=0; i<first; i++) grid.appendChild(document.createElement('div')).className="bg-gray-900/30 h-16 border-r border-b border-gray-800";
        for(let i=1; i<=last; i++) {
            const day = document.createElement('div');
            day.className = "bg-[#1c1f26] h-16 border-r border-b border-gray-800 p-1";
            const dStr = `${y}${String(m+1).padStart(2,'0')}${String(i).padStart(2,'0')}`;
            const matches = apiData.filter(d => String(d.subscrptStrtDt) === dStr);
            day.innerHTML = `<span>${i}</span>` + matches.map(d => `<div class="ipo-tag truncate">ğŸ“¢${d.corpNm}</div>`).join('');
            grid.appendChild(day);
        }
    }

    // ì±„íŒ… ë° ë¡œê·¸ì¸ ìƒíƒœ ìœ ì§€ (ê¸°ì¡´ ë¡œì§)
    onAuthStateChanged(auth, (user) => {
        if(user) {
            document.getElementById('userInfo').classList.remove('hidden');
            document.getElementById('loginBtn').classList.add('hidden');
            document.getElementById('userNick').innerText = user.displayName;
        }
    });

    fetchPublicData();
</script>
</body>
</html>
